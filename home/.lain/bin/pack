#!/usr/bin/env bash

# -=-=--=-=--=-=--=-=--=-=--=-=--=-=--=-=--=-=--=-=--=-=-
# 脚本用途: 支持打包一个或多个文件/目录, 支持解压一个或多个文件
# -=-=--=-=--=-=--=-=--=-=--=-=--=-=--=-=--=-=--=-=--=-=-

set -euo pipefail

# 定义颜色
RED='\033[0;31m'        # 红色
GREEN='\033[0;32m'      # 绿色
NC='\033[0m'            # 重置色

# 默认变量
MODE="pack"         # 默认为打包模式
USE_GZIP=0          # 默认不使用 Gzip
TARGETS=()          # 存储目标文件列表

# ----------------------------------
# 函数: 打印帮助信息
# ----------------------------------
usage() {
    printf "Usage:\n"
    printf "  %s <files...> [flags]\n" "$(basename "$0")"
    printf "\nFlags:\n"
    printf "  -z, --gzip            Use gzip compression (for packing)\n"
    printf "  -x, --extract         Extract mode (unpack archives)\n"
    printf "  -h, --help            Show this help message\n"
}

# ----------------------------------
# 打包时, 目标可以是文件, 也可以是目录, 只要存在即可
# ----------------------------------
check_pack_targets() {
    local files=("$@")
    for item in "${files[@]}"; do
        if [[ ! -e "$item" && ! -L "$item" ]]; then
            printf "${RED}Error:${NC} '%s' does not exist.\n" "$item" >&2
            exit 1
        fi
    done
}

# ----------------------------------
# 解压时, 目标必须是文件
# ----------------------------------
check_unpack_targets() {
    local files=("$@")
    for item in "${files[@]}"; do
        if [[ ! -f "$item" ]]; then
            printf "${RED}Error:${NC} '%s' does not exist.\n" "$item" >&2
            exit 1
        fi
    done
}

# ----------------------------------
# 打包逻辑
# ----------------------------------
pack_files() {
    local output_dir="."
    local tar_options="-cf"
    local extension=".tar"

    # 设置压缩选项
    if [[ $USE_GZIP -eq 1 ]]; then
        tar_options="-czf"
        extension=".tar.gz"
    fi

    # 如果有多个目标, 创建统一输出目录
    if [[ "${#TARGETS[@]}" -gt 1 ]]; then
        local dir_name="packed_result"
        if mkdir -p "$dir_name"; then
            output_dir="$dir_name"
            printf "Output directory created: %s\n" "$output_dir"
        else
            printf "${RED}Error:${NC} Failed to create directory %s\n" "$dir_name" >&2
            exit 1
        fi
    fi

    # 循环打包
    for item in "${TARGETS[@]}"; do
        local base_name="$(basename -- "$item")"
        local archive_name="${base_name}${extension}"
        local full_output_path="${output_dir}/${archive_name}"

        if [[ -e "$full_output_path" ]]; then
            printf "${RED}Error:${NC} %s already exists, skipping.\n" "${full_output_path}" >&2
            continue
        fi

        if tar "${tar_options}" "${full_output_path}" -- "$item"; then
            printf "${GREEN}Packed -> %s${NC}\n" "${full_output_path}"
        else
            printf "${RED}Error:${NC} Failed to pack %s\n" "$item" >&2
        fi
    done
}

# ----------------------------------
# 解压逻辑
# ----------------------------------
unpack_files() {
    local output_dir="."

    # 如果有多个目标, 创建统一解压目录
    if [[ "${#TARGETS[@]}" -gt 1 ]]; then
        local dir_name="unpacked_result"
        if mkdir -p "$dir_name"; then
            output_dir="$dir_name"
            printf "Output directory created: %s\n" "$output_dir"
        else
            printf "${RED}Error:${NC} Failed to create directory %s\n" "$dir_name" >&2
            exit 1
        fi
    fi

    # 循环解压
    for item in "${TARGETS[@]}"; do
        if tar -xf "$item" -C "$output_dir"; then
            printf "${GREEN}Extracted -> %s (into %s/)${NC}\n" "$item" "$output_dir"
        else
            printf "${RED}Error:${NC} Failed to extract %s\n" "$item" >&2
        fi
    done
}

# ----------------------------------
# 主程序入口
# ----------------------------------
while [[ $# -gt 0 ]]; do
    key="$1"
    case $key in
        -z|--gzip)
            USE_GZIP=1
            shift
            ;;
        -x|--extract)
            MODE="unpack"
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        -*)
            printf "${RED}Error:${NC} Unknown flag %s\n" "$1" >&2
            usage >&2
            exit 1
            ;;
        *)
            TARGETS+=("$1")
            shift
            ;;
    esac
done

# 检查是否有输入文件
if [[ "${#TARGETS[@]}" -eq 0 ]]; then
    printf "${RED}Error:${NC} No files specified.\n" >&2
    usage >&2
    exit 1
fi

# 根据模式执行相应函数
if [[ "$MODE" == "unpack" ]]; then
    check_unpack_targets "${TARGETS[@]}"
    unpack_files
else
    check_pack_targets "${TARGETS[@]}"
    pack_files
fi
