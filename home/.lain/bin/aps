#!/usr/bin/env bash

# -=-=--=-=--=-=--=-=--=-=--=-=--=-=--=-=--=-=--=-=--=-=-
# 脚本用途: 使用 ADB 推送文件/目录到 Android 设备
# -=-=--=-=--=-=--=-=--=-=--=-=--=-=--=-=--=-=--=-=--=-=-

set -euo pipefail

# 依赖检查
dependencies=("adb" "paplay")
for cmd in "${dependencies[@]}"; do
    if ! command -v "$cmd" &> /dev/null; then
        printf "Error: Missing dependency: %s\n" "$cmd" >&2
        exit 1
    fi
done

# 定义颜色
RED='\033[0;31m'        # 红色
GREEN='\033[0;32m'      # 绿色
BLUE='\033[0;34m'       # 蓝色
NC='\033[0m'            # 重置色

# 推送目录
push_dir="/sdcard/inbox"

# 拉取目录
pull_dir="/sdcard/outbox"

# 检查设备是否连接
if [[ -z "$(adb devices | tail -n +2 | grep -v '^$')" ]]; then
    printf "Error: 未检测到任何 ADB 连接的设备\n" >&2
    exit 1
fi

adb_push() {
    # 路径校验, 目标可以是文件, 也可以是目录, 只要存在即可
    for item in "$@"; do
        if [[ ! -e "$item" && ! -L "$item" ]]; then
            printf "${RED}Error:${NC} '%s' does not exist.\n" "$item" >&2
            exit 1
        fi
    done

    if ! adb shell "mkdir -p $push_dir"; then
        printf "${RED}Error:${NC} 在 ADB 设备上创建目录 '%s' 失败\n" "$push_dir" >&2
        exit 1
    fi

    for source in "$@"; do
        file_size=$(du -sh --apparent-size "$source" | awk '{print $1}')
        printf "▪ Pushing: ${GREEN}%s${NC}  Size: ${BLUE}%s${NC}\n" "$source" "$file_size"
        adb push "$source" "$push_dir"
        printf "\n"
    done
}

adb_pull() {
    if ! adb shell "test -d $pull_dir"; then
        printf "${RED}Error:${NC} ADB 设备源目录 '%s' 不存在\n" "$pull_dir" >&2
        exit 1
    fi

    printf "Pulling...\n"
    adb pull "$pull_dir" .
    printf "\n"
}

if [[ "$#" -eq 0 ]]; then
    printf "Mode: ${BLUE}Pull${NC} (from %s)\n\n" "$pull_dir"
    adb_pull
else
    printf "Mode: ${BLUE}Push${NC} (to %s)\n\n" "$push_dir"
    adb_push "$@"
fi

printf "Done.\n"

notify-send "aps" "transmission completed."
"$WM_SCRIPTS/play_audio.sh" "complete.oga"
