#!/usr/bin/env bash

# -=-=--=-=--=-=--=-=--=-=--=-=--=-=--=-=--=-=--=-=--=-=-
# 脚本用途: 使用 ADB 推送文件/目录到 Android 设备
# -=-=--=-=--=-=--=-=--=-=--=-=--=-=--=-=--=-=--=-=--=-=-

set -euo pipefail

# 依赖检查
dependencies=("adb" "paplay")
for cmd in "${dependencies[@]}"; do
    if ! command -v "$cmd" &> /dev/null; then
        printf "Error: Missing dependency: %s\n" "$cmd" >&2
        exit 1
    fi
done

# 定义颜色
RED='\033[0;31m'        # 红色
GREEN='\033[0;32m'      # 绿色
BLUE='\033[0;34m'       # 蓝色
NC='\033[0m'            # 重置色

if [[ "$#" -eq 0 ]]; then
    printf "Error: Invalid argument.\n" >&2
    printf "Usage: %s <paths...>\n" "$(basename "$0")" >&2
    exit 1
fi

# 路径校验, 目标可以是文件, 也可以是目录, 只要存在即可
for item in "$@"; do
    if [[ ! -e "$item" && ! -L "$item" ]]; then
        printf "${RED}Error:${NC} '%s' does not exist.\n" "$item" >&2
        exit 1
    fi
done

# 检查设备是否连接
if [[ -z "$(adb devices | tail -n +2 | grep -v '^$')" ]]; then
    printf "Error: 未检测到任何 ADB 连接的设备\n" >&2
    exit 1
fi

target_dir="/sdcard/aps_inbox"

if ! adb shell "mkdir -p '$target_dir'"; then
    printf "${RED}Error:${NC} 在 ADB 设备上创建目录 '%s' 失败\n" "$target_dir" >&2
    exit 1
fi

for source in "$@"; do
    file_size=$(du -sh --apparent-size "$source" | awk '{print $1}')
    printf "Pushing: ${GREEN}%s${NC}  Size: ${BLUE}%s${NC}\n" "$source" "$file_size"
    adb push "$source" "$target_dir"
    printf "\n"
done

printf "Done.\n"

notify-send "ADB push" "all files have been transferred."
"$WM_SCRIPTS/play_audio.sh" "complete.oga"
