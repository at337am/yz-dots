#!/usr/bin/env bash

# -=-=--=-=--=-=--=-=--=-=--=-=--=-=--=-=--=-=--=-=--=-=-
# 脚本用途：
# 该脚本用于为指定的文件创建带时间戳的备份副本。
# 功能说明：
# 1. 接受一个或多个文件作为参数进行备份。
# 2. 对每个文件生成唯一备份文件名，格式为：
#    原文件名_YYMMDD_HHMMSS_纳秒.bak
# 3. 如果生成的备份文件名已存在，则附加随机字符串以保证唯一性。
# 4. 保留文件原有属性（cp -a），并输出备份结果。
# -=-=--=-=--=-=--=-=--=-=--=-=--=-=--=-=--=-=--=-=--=-=-

if [[ "$#" -eq 0 ]]; then
    printf "Error: Invalid arguments.\n" >&2
    printf "Usage: bak <file>...\n" >&2
    exit 1
fi

for file in "$@"; do
    if [[ ! -f "$file" ]]; then
        printf "\033[31mError: '%s' is not a regular file\033[0m\n" "$file" >&2
        continue
    fi

    backup_file="${file}_$(date +%y%m%d_%H%M%S_%N).bak"

    if [[ -e "$backup_file" || -L "$backup_file" ]]; then
        backup_file+=".$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 6)"
    fi

    if cp -a -- "$file" "$backup_file"; then
        printf "\033[32mBacked up -> %s\033[0m\n" "$backup_file"
    else
        printf "\033[31mError: Failed to backup '%s'\033[0m\n" "$file" >&2
        continue
    fi
done
